
{% extends "base.html" %}
{% block content %}

<div class="card" 
     style="
       margin: 0 auto 32px auto; 
       padding: 24px 32px; 
       max-width: 480px; 
       background-color: #0e1525; 
       border: 1px solid #1e2b40; 
       border-radius: 16px; 
       box-shadow: 0 4px 12px rgba(0,0,0,0.4);
     ">
  <form method="post" action="{{ url_for('update_starting_balance') }}" 
        style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
        
      <label class="subtle" style="font-size: 14px; color: #b0c7e1;">Starting Balance</label>
      <input type="number" name="starting_balance" required step="1" 
             style="
               width: 100%;
               max-width: 240px;
               padding: 10px 14px;
               border: 1px solid #2b3b52;
               border-radius: 8px;
               background-color: #101a2b;
               color: #dce6f3;
               font-size: 15px;
               text-align: center;
             "
             value="{{starting_balance}}">
             
      <button type="submit" 
              style="
                background-color: #14b8a6;
                border: none;
                border-radius: 8px;
                padding: 10px 24px;
                color: #fff;
                font-weight: 600;
                cursor: pointer;
                font-size: 15px;
                transition: all 0.25s ease;
              "
              onmouseover="this.style.backgroundColor='#0fa294'"
              onmouseout="this.style.backgroundColor='#14b8a6'">
        Update
      </button>
  </form>
</div>


  <h2>{{ first_day.strftime('%B %Y') }}</h2>
  <div class="calendar">
    {% for cell in cells %}
      <div class="card {% if not cell.in_month %}dim{% endif %}">
        <div class="date">{{ cell.date.strftime('%d %a') }}</div>
        {% if cell.day_pl is not none %}
          <div class="pl {% if cell.day_pl >= 0 %}positive{% else %}negative{% endif %}">
            {{ '%+.2f$'|format(cell.day_pl) }}
            <br>
          </div>
          {% else %}
          <div class="subtle">{% if cell.in_month %}No trades{% else %}...{% endif %}</div>
          {% endif %}
          {% if cell.daily_risk and cell.in_month %}
            <div class="pl risk">
                {{ '⚠️ %.2f$'|format(cell.daily_risk) }}
              <br>
            </div>
          {% else %}
            <div class="subtle">Daily risk: —</div>
          {% endif %}


  <button class="add-trade-btn" onclick="openTradeModal('{{ cell.date.isoformat() }}')" title="Add trade" style="position:absolute;top:8px;right:8px;padding:2px 8px;font-size:18px;line-height:1;border-radius:50%;border:none;background:var(--cell-bg,#121a26);cursor:pointer;">+</button>
        <!-- Trade Modal -->
        <div class="trade-modal" id="trade-modal-{{ cell.date.isoformat() }}" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;align-items:center;justify-content:center;">
          <div style="background:var(--cell-bg,#121a26);padding:24px 32px;border-radius:8px;min-width:320px;position:relative;box-shadow:0 2px 16px rgba(0,0,0,0.2);">
            <style>
              .calendar .card, .trade-modal > div {
                --cell-bg: #121a26;
              }
            </style>
            <button onclick="closeTradeModal('{{ cell.date.isoformat() }}')" style="position:absolute;top:8px;right:8px;font-size:18px;border:none;background:none;cursor:pointer;">&times;</button>
            <h3>Add Trade for {{ cell.date.strftime('%d %b %Y') }}</h3>
            <form action="{{ url_for('create_trade') }}" method="post">
              <input type="hidden" name="trade_date" value="{{ cell.date.isoformat() }}"/>
              <input name="symbol" type="text" placeholder="SYM" style="width:72px"/>
              <input name="position_size" type="number" step="1" placeholder="Qty" style="width:80px"/>
              <input name="entry_price" type="number" step="0.01" placeholder="Entry" style="width:90px"/>
              <input name="exit_price" type="number" step="0.01" placeholder="Exit" style="width:90px"/>
              <button type="submit">Save</button>
            </form>
            <div class="subtle" style="margin-top:8px;">Only trades are entered manually; balances update via triggers.</div>
          </div>
        </div>
        {% if cell.week_pl is not none %}
          <div class="weekpl">Week total: {{ '%+.2f$'|format(cell.week_pl) }}</div>
        {% endif %}
      </div>

      <script>
      function openTradeModal(date) {
        var modal = document.getElementById('trade-modal-' + date);
        if (modal) modal.style.display = 'flex';
      }
      function closeTradeModal(date) {
        var modal = document.getElementById('trade-modal-' + date);
        if (modal) modal.style.display = 'none';
      }
      // Optional: close modal on background click
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('trade-modal')) {
          e.target.style.display = 'none';
        }
      });
      </script>
    {% endfor %}
  </div>

{% endblock %}
